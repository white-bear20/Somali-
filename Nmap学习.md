# Nmap

<h2 id="menu">目录</h2>

* ### [Nmap是什么?](#1)
* ### [Nmap语法](#2)
* ### [主机发现](#3)
* ### [端口扫描](#4)
* ### [指纹识别与探测](#5)
* ### [伺机而动](#6)
* ### [防火墙/IDS逃逸](#7)
* ### [保存结果](#8)
***

> <h2 id="1">Nmap是什么?</h2>
    Nmap(Network Mapper),它是一个开源的网络探测工具，但是对于现在的Nmap来说这个定位是不准确的，因为Nmap通过各种脚本进行扩展，已经实现了很多额外功能，现在的Nmap可以说是一个多功能的渗透工具，而不仅仅是用来做网络探测。

> <h2 id="2">Nmap语法</h2>
    Nmap [选项|多选项|协议] [目标]
    
    根据语法规则，选项和多选项和协议，还有选项和参数之间，以及目标之间都应该由空格来进行分割

> <h2 id="3">主机发现</h2>
0. 简单扫描
    * `nmap 192.168.0.1`
    * 对目标进行迅速的扫描，发现对方主机在线情况以及端口开放情况
1. 全面扫描(-A)
    * `nmap -A 192.168.0.1`
    * 全面扫描指定[IP\域名]，可能需要一定时间，它可以获取目标端口，以及端口可能存在的服务及版本，操作系统等信息
2. 指定C段扫描(指定范围 '-',或者扫描整个C段/24)
    * `nmap 192.168.0.1-254`
    * `nmap 192.168.0.1/24`
3. Ping扫描(-sP)
    * `nmap -sP 192.168.0.1`
    * 快速进行主机发现，但是现在很多主机都默认拦截Ping包,所以可能存在的主机也会扫不到
4. 无Ping扫描(-p0)
    * `nmap -P0 [协议1] [协议2] 192.168.0.1`
    * 主要用于目标主机防火墙禁止Ping的情况下，上面所谓的协议1，协议2，是只在扫描时所用的协议，默认是使用 TCP ，ICMP ，UDP
    * 如果想看这些协议是如何判断主机是否存活的可以使用 `nmap -p0 --packet-trace 192.168.0.1`
    * 如果要指定协议就要使用对应的协议编号, TCP(6),ICMP(1),IGMP(2),UDP(17),`nmap -p0 6,17,2 192.168.0.1`
5. TCP SYN Ping扫描(-PS)
    * `nmap -PS 192.168.0.1`
    * 通过SYN/ACK和RST响应来对目标主机是否存活进行判断，但是在特定情况下防火墙可能会丢弃RST包，这样扫描就不准确了，我们可以指定多个端口来进行扫描，注意，只是判断主机是否存活
    * `nmap -PS80,100-1000 192.168.0.1`
6. TCP ACK Ping扫描(-PA)
    * `nmap -PA 192.168.0.1`
    * 主要用于防火墙封锁SYN报文的时候，直接发送标志位为ACK的包，如果目标存活就会返回一个RST包
    * `nmap -PS -PA 192.168.0.1` 即发送SYN包又发送ACK包
7. UDP Ping扫描(-PU)
    * 'nmap -PU 192.168.0.1'
    * 使用一个空的UDP报文发送到指定的端口，如果不指定端口的话默认是40125
8. ARP Ping扫描(-PR)
    * `nmap -PR 192.168.0.1`
    * ARP ping扫描在局域网中是最有效的扫描方式，因为在本地局域网中防火墙是不会禁止ARP请求的
    * 如果Nmap发现目标主机在自己的局域网上它就会默认使用ARP扫描，不管你有没有指定其他类型.
9. 扫描列表(-sL)
    * `nmap -sL 192.168.0.1/24`
    * 这种方法只列出指定网络上的每台主机，不发送任何报文到目标主机，默认情况下还会对主机进行反向域名解析，如果要禁止反向域名解析，加上 -n 命令就好了
10. 反向域名解析(-R)
    * `nmap -R -sL 192.168.0.1/24`
    * 该方法主要是用于快速发现网段中有哪些服务器绑定了域名
11. 使用系统域名解析器(--system-dns)
    * `nmap --system-dns 192.168.0.2 192.168.0.1`
    * 默认情况下Nmap是直接通过发送查询到我主机上配置的域名服务器来解析域名，但是为了提高性能时，我们可以使用系统自带的解析器（本地DNS）
12. 扫描IPv6地址(-6)
    * `nmap -6 fe80::844:1c76:82cd:f24`
13. 路由跟踪()--traceroute)
    * `nmap --traceroute 192.168.75.1`
    * 使用这个参数可以看到本地计算机到目标之间所经过的网络节点，并且可以看到通过各个节点的时间
14. SCTP INIT Ping扫描(-PY)
    * `nmap -PY 192.168.75.1`
    * SCTP是IETF在2000年定义的一个传输层协议，STCP可以看作是TCP协议的改进，它改进了TCP的一些不足，STCP INIT Ping扫描通过向目标发送INIT包，根据目标主机的响应进行判断是否存活

> <h2 id="4">端口扫描</h2>
`注意：Nmap进行的端口扫描返回的结果不一定准确，因为这些扫描结果是目标或者说是目标防火墙反馈回来的，可能会存在误导信息`  
`Nmap中所有的端口扫描选项都是 -s<x>这种形式,例如-sA,-sU`
0. Nmap端口识别的六种状态
    1. Open:端口对外开放
    2. Colosed:端口关闭
    3. filtered:被拦截了
    4. Unfitered:端口可以访问，但是不知道是开放还是关闭，这里要注意，端口是否可以访问和是否开关是两码事，不过这个状态只有使用ACK扫描时才会呈现
    5. Open|filtered:开放或者过滤
    6. Colosed|Filtered:关闭或者过滤
    注意：当碰到这些情况时，可以换换扫描方式，或者换扫描器，将扫描到的信息拿到一起分析，会更靠谱一些
1. 速度选项(-T(0-5))
    * -T0 非常满，用于IDS逃避
    * -T1 缓慢，用于逃避IDS
    * -T2 降低速度，以降低对带宽的消耗
    * -T3 默认，根据目标反应自动调整
    * -T4 快速扫描，常用的扫描方式，需要再很好的网络环境下，请求可能会淹没目标
    * -T5 急速扫描，牺牲精准度提升扫描速度，而且已经是非常不虚了，淦就完了。
    * `nmap -T5 192.168.0.1`
2. 选择端口(-p)
`默认情况下Nmap对端口的扫描方式是按照从小到大进行的，或者是参照nmap-services文件中列出的端口进行扫描`
    * `nmap -p 80 192.168.0.1` 扫描目标80端口是否开放
    * `nmap -p 80-1000 192.168.0.1` 扫描目标80到1000之内的端口是否开放
    * 还可以指定扫描目标是TCP端口还是UDP端口又或者两个都扫，要再端口号前面加上T:或者U:,而且如果要扫描TCP又要扫描UDP的话，那么至少要指定一种TCP和UDP的扫描方式
    * `nmap -sU -sS -p T:80,U:53 192.168.0.1`
3. 快速扫描(-F)
    * `nmap -F 192.168.0.1`
    * 它并不会扫描所有端口，只会扫描有限的端口，再Nmap中的nmap-services包含了默认扫描的端口，也可以用--datadir选项指定自己的nmap-services文件
4. 扫描常用端口(--top-ports)
    * `nmap --top-ports 100 192.168.0.1`
    * 上面这个命令是用来扫描常用的前100个端口
5. TCP SYN扫描(-sS)
    * `nmap -sS 192.168.0.1`
    * 这种扫描方式比较隐蔽，因为它不会建立TCP连接，但是扫描速度却很快，它主要是就是向目标端口发送一个SYN包，如果对方返回一个RST包则说明端口关闭，但是如果返回了一个SYN/ACK包，它就会返回一个RST包给对方，关闭连接。
    * 当SYN扫描不能用时，TCP连接扫描会使用默认的TCP扫描
6. TCP连接扫描(-sT)
    * `nmap -sT 192.168.0.1`
    * 这种方式会建立TCP连接，稳是稳，但是速度比不扫SYN扫描，而且还容易被发现
7. UDP扫描(-sU)
    * `nmap -sU 192.168.0.1`
    * 这种扫描方式非常慢，所以用的时候，建议用来扫描指定端口。
8. 隐蔽扫描(-sN,-sF,-sX)
    * `nmap -sN 192.168.0.1`
    * -sN是Null扫描，它发送非常规的TCP包去目标主机，也就是标记位全为0，如果目标端口关闭了，就会返回一个RST包，开放则不响应
    * `nmap -sF 192.168.0.1`
    * -sF是FIN扫描，它通过把FIN标志位设置为1去发送TCP包，如果目标端口开放，就会返回一个RST包，关闭则不响应
    * `nmap -sX 192.168.0.1`
    * -sX是Xmas扫描，它是根据RFC793规则来的，将FIN,PSH,URG标记位全部打开，目标端口开放就响应一个RST包，但是前提是要对方遵守RFC
9. TCP ACK扫描(-sA)
    * `nmap -sA 192.168.0.1`
    * 这种扫描方有个致命缺点，它无法确定端口是开放的还是被过滤的
10. TCP窗口扫描(-sW)
    * `nmap -sW 192.168.0.1`
    * 它和ACK扫描方式的原理几乎是一样的，这种扫描方法获得的信息也极为不准确
11. 自定义TCP扫描(--scanflags)
    * `nmap --scanflags ACKSYNFIN 192.168.0.1`
    * 通过上面这种字符的方式去设置标志位，无所谓先后，但是字符之间不要有空格
12. 空闲扫描(-sI)
    * `nmap -sI 192.168.0.2:4444 192.168.0.1`
    * 利用僵尸主机向目标发起扫描，感觉就像利用一个主机作为跳板，然后去扫描另一个主机
13. IP协议扫描(-sO)
    * `nmap -sO 192.168.0.1`
    * 扫描目标系统支持的IP协议

> <h2 id="5">指纹识别与探测</h2>
0. 版本探测(-sV)
    * `nmap -sV 192.168.0.1`
    * 这个选项不是进行端口扫描，而是对目标端口上对应的服务进行指纹识别
1. 全端口版本探测(--allports)
    * `nmap --allports 192.168.0.1`
    * 扫描所有端口，进行服务指纹识别
2. 扫描强度设置(--version-intensity)
    * `nmap -sV --version-intensity 1 192.168.0.1`
    * 这个参数是为每个探测报文赋予1~9之间的值，值越高，服务越可能被正确识别，但是时间也会更久，默认强度是7，强度范围只能是1~9之间
3. 轻量级扫描(--version-light)
    * `nmap -sV --version-light 192.168.0.1`
    * 相当于 --version-intensity 2
4. 重量级扫描(--version-all)
    * `nmap -sV --version-all 192.168.0.1`
    * 相当于 --version-intensity 9
5. 获取扫描详细信息(--version-trace)
    * `nmap -sV --version-trace 192.168.0.1`
    * 可以看到扫描过程
6. RPC扫描(-sR)
    * `nmap -sS -sR 192.168.0.1`
    * 这个选项多是和其他端口扫描选项结合，它对所有被发现开放的TCP/UDP端口执行SunRCP程序的NULL命令，来判断对方是否是RPC端口
7. 操作系统探测(-O)
    * `nmap -O 192.168.0.1`
    * 听说 -O 和 -A 更配哦
8. 对指定目标进行操作系统检测(--osscan-limit)
    * `nmap -P0 192.168.0.1/24 -A --osscan-limit 192.168.0.1`
    * 这个参数需要配合-O或者-A使用
9. 推测目标系统(--osscan-guess)
    * `nmap --osscan-guess 192.168.0.1`
    * 当Nmap无法准备识别目标系统的时候，它会从最接近的数据中取值，大胆的猜测目标系统

> <h2 id="6">伺机而动</h2>
0. 调整扫描组的大小(--min-hostgroup,--max-hostgroup)
    * `nmap --min-hostgroup 10 192.168.0.1`
    * `nmap --max-hostgroup 100 192.168.0.1`
    * 默认情况下Nmap是先从最小的组开始扫描，最小值为5，然后慢慢增大，最大为1024，我们可以通过上面两个参数来设置最大最小值，以控制，探测包的大小
1. 调整探测报文的并行度(--min-parallelism,--max-parallelism)
    * `nmap --min-parallelism 1 192.168.0.1`
    * `nmap --max-parallelism 1 192.168.0.1`
    * 这是设置探测包并行的，如果min-parallelism被设置为1的话，那么就表示最少同时给目标发一个包，如果是max-parallelism被设置为1的话，那么表示不能同时向目标发多个包，只能发1个
2. 调整探测报文超时时间(--min-rtt-timeout,--max-rtt-timeout,--initial-rtt-timeout,单位为【毫秒】)
    * `nmap --max-rtt-timeout 1000ms 192.168.0.1`
    * 一般情况下rtt值不得小于100，不要超过1000
3. 放弃反应慢的主机（--host-timeout）
    * `nmap --host-timeout 100ms 192.168.0.1`
    * 一般设置为1800000毫秒，保证Nmap对单个主机的扫描时间不会超过半小时，当然这半个小时之内不会只扫它一个

> <h2 id="7">防火墙/IDS逃逸</h2>
1. 报文分段(-f)
    * `nmap -f 192.168.0.1`
2. 指定偏移大小(--mtu)
    * `nmap --mtu 16 192.168.0.1`
    * MTU（最大传输单元）这个值可以设定TCP/IP协议传输数据报时的最大传输单元，它的值一定要是8的倍数
3. IP欺骗(-D)
    * `nmap -D RND:10 192.168.0.1`
    * 随机生成10个诱饵IP进行扫描
    * `nmap -D 192.168.0.2,192.168.0.3 192.168.0.1`
    * 指定诱饵IP进行扫描
    * 通过抓包发现，只是IP进行了改变，但是MAC地址并没有变，如果全变了，那就要思考是怎么通信的了，但是在这种情况下，那么可以用于外网扫描吗
    * 注意这种方法在进行版本探测或者TCP扫描的时候是无效的
4. 源端口欺骗(--source-port / -g 这两个参数效果一样)
    * `nmap -g 53 192.168.0.1`
    * 从设置好的端口进行发送数据包扫描
5. 指定发包长度(--data-length)
    * `nmap --data-length 30 192.168.0.1`
    * 发送30个字节大小的包
    * Nmap的扫描包默认都是不带内容的，空包，可能会由此被过滤掉，我们可以选着设置包的长度，往里面填充垃圾数据而导致绕过
6. 伪造MAC地址(--spoof-mac)
    * `nmap --spoof-mac 0 192.168.0.1`
    * 0表示随机产生一个MAC，还可以自己指定一个MAC，或者从指定厂商产生一个MAC
    * 伪造MAC和伪造IP同时只能用一个（在内网进行测试）

> <h2 id="8">保存结果</h2>
1. 标准保存(-oN)
    * `nmap -sP -oN scan.txt 192.168.0.1`
2. XML格式保存(-oX)
    * `nmap -sP -oX scan.xml 192.168.0.1`
***
[回到顶部](#menu)