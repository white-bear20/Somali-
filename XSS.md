# XSS学习笔记

<h2 id="menu">目录</h2>

1. ### [什么是XSS?](#1)
2. ### [漏洞产生原理&危害](#2)
3. ### [注入点](#3)
4. ### [漏洞利用](#4)
5. ### [漏洞复现](#5)
6. ### [绕过手法](#6)
7. ### [同源策略](#7)
8. ### [跨域方法](#8)
9. ### [防御手段](#9)

***

> <h2 id="1">0x01 什么是XSS?</h2>
    跨站脚本攻击(Cross site scripting)为了不和CSS缩写混淆,所以被称为XSS,恶意攻击者往WEB页面里面插入了恶意的Script代码，然后当用户浏览该网页时，嵌入的Script代码被执行，从而达到攻击用户的目的。
### XSS类型介绍
    * 反射型XSS(非持续性XSS,一次性攻击)
        攻击者通过某种形式(例如邮件)将包含XSS代码的连接发送给正常用户，当用户点击时，服务器接收该用户的请求，并进行处理，然后把带有XSS的代码发送给用户，由用户的浏览器解析执行代码触发XSS漏洞
    * 存储型XSS(持续性XSS)
        XSS代码存储在目标服务器的数据库中，这样的话一有用户访问页面就会被触发，这种攻击方法隐蔽性会更强,存在的攻击点一般在论坛，博客，留言板，等地方。
    * DOM型XSS
        通过DOM对页面进行修改，那么如果使用DOM对页面添加XSS代码，就会形成XSS漏洞，只要用户访问就会被触发。
> <h2 id="2">0x02 漏洞产生原理 &  危害</h2>
### 漏洞产生原理
`主要网页对用户提交的请求没有做过滤，或者过滤做的不完善，导致用户提交了恶意代码，并且这些恶意代码会被返回到HTML页面，导致恶意代码被浏览器解析执行。`
### 危害    
    cookie劫持（窃取cookie）
    后台增删改文章等操作（类似于csrf骗取用户点击，利用js模拟浏览器发包，借助xmlhttprequest类）
    钓鱼，利用xss构造出一个登录框，骗取用户账户密码。
    Xss蠕虫（利用xss漏洞进行传播）
    修改网页代码
    利用网站重定向
    获取用户信息（如浏览器信息，IP地址等）
    注：根据上面这些危害，下面会逐个实现

> <h2 id="3">0x03 注入点</h2>
    关于XSS的注入点，我想说，只要是提交的数据会回显到HTML代码中的地方，都可以试试，不管是页面中的输入框，或者是HTTP头，都行，只要它会回显到HTML代码中。

> <h2 id="4">0x04 漏洞利用</h2>
```
    可能在学习的时候我们最常用的语句就是<script>alert(1)</script>,但是这种代码并没有什么实际性的功能，它的作用只是证明XSS漏洞的存在，关于XSS漏洞的利用，在网上有许多的XSS平台，也可以在GitHub上寻找XSS平台的源码自己在本地或者是服务器搭建，这种平台有什么用呢？例如说我要做Cookie窃取，那么我可以去XSS平台上找一个Cookie窃取的JS代码，然后将它放入到存在XSS漏洞的页面中，只要插入成功，那么我们要做的就是等待就好了，等受害者触发XSS漏洞，然后它的Cookie就会被反弹到我们所用的XSS平台。
```
### XSS平台搭建
    蓝莲花战队的XSS平台：链接：https://pan.baidu.com/s/1jatb-54_JJrop81fZUHiLw  提取码：lpi1 
    BEEF //这个是一个专门用于WEB的渗透工具，他也可以用于做XSS平台，在kali中默认安装没安装的话可以用`apt-get beef`,然后进入到
### XSS在线平台
    xsshs.cn

> <h2 id="5">0x05 漏洞复现</h2>
*原本是准备写实现XSS的代码，但是发现太菜，写不来，那就先学习一下BEEF-XSS这个工具，具体可以看BEEF-XSS的学习笔记*
*关于漏洞复现，其实应该是有问题的JS代码，不过这些东西也可以去看靶场中的代码，例如DVWA*

> <h2 id="6">绕过手法</h2>
*关于绕过手法，使用的是XSS-challenge这个靶场环境里面的关卡，来进行研究，在火狐的地址栏中输入view-source:目标地址，通过这种方法可以直接查看网页源码，然后在这个页面进行插入，会更直观，右击查看源代码也行*

1. 寻找页面所有会回显的地方，因为有的页面它不仅仅会把数据回显到页面还有可能回显到标签的属性中，只是不显示而已，而可能这些地方由于疏忽就不会做过滤
2. 如果在标签的属性页中存在注入点，可以使用触发事件进行注入，如果有对事件做黑名单的话，可以加载一个字典去跑看看有没有漏网之鱼
3. javascript伪协议
4. 大小写绕过
5. 双写绕过
6. 编码绕过
```
    unicode:
        使用这种绕过方法要注意，由于&#这两个符号在url中都有特殊含义，所以不要把编码的字符放进url去执行，可以放进输入框中提交，这样浏览器会做处理，可以被编译，也可以进行url编码之后在URL中直接走
        例如说只要出现了src就会在r前面加个_变成s_rc,构造payload s %26%23114 c; 注意这里的114是r的10进制ASCII码

        其实还可以用HEX，在数字前面加x然后后面写十六进制就好了，例如 s %26%23x72 c;,而且这里注意,x后面可以出现很多0,有时候可以用来绕waf，例如s%26%23x0000000000072c;
        注意:在s和c前面加些空格怕看混
``` 
7.Angularjs绕过，这种手段出现在`XSS挑战之旅的第15关`，Angularjs也是一个前端的JS框架，引用这个框架时，也要载入外部JS文件，像JQuery一样
```
    在15关中，它引用了ng-include这个指令，并且输入是可控的，这个指令的作用是引用一个外部的htm文件，一般是只能引用同域名下的文件
    payload:http://localhost/xss_vuln/level15.php?src='level1.php?name=<img src=x  onerror="alert()"/>',包含的文件要写在''中。
```
8. 空格绕过，思路和SQL一样，用%0a,%09,%a0,%0b,%0c
9. 事件绕过，有时候会过滤一些常用事件例如onclick,onerror,我们可以加载一个事件字典去fuzzing一下
10. 标签绕过，同上

> <h2 id="7">同源策略</h2>
#### 什么是同源策略?
    同源策略(Same Origin Policy,SOP)是WEB应用程序的一种安全模型，它控制了网页中DOM之间的访问。它只是一个模型，而不是标准。所以实现的方式可能会各部相同（哪怕是标准在实现时也可能会千差万别），
    同源策略被广泛的应用在处理WEB内容的各种客户端上，SOP的影响范围包括：普通的HTTP请求，XMLHttpRequest,XSLT,XBL。
#### 什么是源？
    所谓的源就是指，源地址，所谓同源，就是要
    协议    端口    主机名
    上面这三个都相同的地址才能算是同源，例如：
    对比URL
        http://www.xiyan.com/test/index.html
    对比URL2
        http://www.xiyan.com/test2/index.html   同源
        http://test.xiyan.com/test/index.html   不同源
        http://www.xiyan.com:8080/test/index.html 不同源
        https://www.xiyan.com/test/index.html 不同源
#### 同源策略做了什么限制
    首先，同源策略只能作用在实现了同源策略的WEB客户端上。
    同源策略禁止读取来自不同源的HTTP回复，而不是禁止脚本执行，所以同源策略防御CSRF时作用非常有限。
    而且一般静态资源不受同源策略限制，例如 js/css/jpg/png

    总体来说页面跨域的行为主要分为三类：
        跨域写，通常是被允许的，例如链接，重定向和表单提交
        跨域嵌入，通常被允许
        跨域读，通常被禁止

> <h2 id="8">跨域方法</h2>
#### src标签
    所有具有src属性的HTML标签都是跨域跨域的，例如<script> <img> <iframe> <link>
    不过为了安全起见，浏览器不允许这种方式下对加载到的资源进行读写操作，并且只能使用标签本身具备的能力
#### CORS（跨域资源共享）
    原理：服务器设置Access-Contorl-Allow-Origin HTTP响应头后，浏览器就会运行跨域请求
#### doucument.domain
    原理：相同主域名不同子域名下的页面，可以设置document.domain让它们同域

> <h2 id="9">防御方法</h2>
    1. 对关键的字符进行实例编码，例如 & # < > ' "
    2. 检测事件的方法，如果有就抛出警告页面
    3. 对一些标签也要做检测
    4. 设置好同源策略
***
[回到顶部](#menu)